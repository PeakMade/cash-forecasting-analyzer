{% extends "base.html" %}

{% block extra_styles %}
<style>
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
    }
    
    .form-group input[type="text"],
    .form-group input[type="file"] {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }
    
    .form-group input:focus {
        outline: none;
        border-color: #667eea;
    }
    
    .file-upload {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        border: 2px dashed #d0d0d0;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .file-upload:hover {
        border-color: #667eea;
        background: #f0f4ff;
    }
    
    .file-upload.has-file {
        border-color: #28a745;
        background: #f0fff4;
    }
    
    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 5px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
        width: 100%;
        margin-top: 20px;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
    
    .section-title {
        font-size: 1.5rem;
        color: #667eea;
        margin: 30px 0 20px 0;
        padding-bottom: 10px;
        border-bottom: 2px solid #e0e0e0;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .loading.active {
        display: block;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .help-text {
        font-size: 0.9rem;
        color: #777;
        margin-top: 5px;
    }
    
    .error-text {
        font-size: 0.9rem;
        color: #dc3545;
        margin-top: 5px;
        font-weight: 600;
    }
    
    .file-upload.has-error {
        border-color: #dc3545;
        background: #fff5f5;
    }
    
    .two-column-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    
    @media (max-width: 768px) {
        .two-column-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="upload-form">
    <h2>Upload Cash Forecast Analysis Files</h2>
    <p class="help-text" style="margin-bottom: 30px;">
        Upload the three required files and provide property information to begin analysis.
    </p>
    
    <form id="analysisForm" enctype="multipart/form-data">
        <div class="section-title">Property Information</div>
        
        <div class="two-column-grid">
            <div class="form-group">
                <label for="property_name">Property Name <span style="color: red;">*</span></label>
                <select id="property_name" name="property_name" required style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1rem;">
                    <option value="">-- Select a Property --</option>
                </select>
                <div class="help-text" id="loading-properties">Loading properties...</div>
            </div>
            
            <div class="form-group">
                <label for="property_address">Property Address <span style="color: red;">*</span></label>
                <input type="text" id="property_address" name="property_address" required placeholder="e.g., 123 University Blvd, College Town, ST">
            </div>
            
            <div class="form-group">
                <label for="zip_code">ZIP Code <span style="color: red;">*</span></label>
                <input type="text" id="zip_code" name="zip_code" required pattern="[0-9]{5}(-[0-9]{4})?" placeholder="e.g., 12345 or 12345-6789">
                <div class="help-text">5-digit or ZIP+4 format</div>
            </div>
            
            <div class="form-group">
                <label for="university">Associated University <span style="color: red;">*</span></label>
                <input type="text" id="university" name="university" required placeholder="e.g., State University">
            </div>
        </div>
        
        <div class="section-title">Required Files</div>
        
        <div class="form-group">
            <label for="cash_forecast">Cash Forecast Excel File *</label>
            <div class="file-upload" id="cash_forecast_zone">
                <input type="file" id="cash_forecast" name="cash_forecast" required accept=".xlsx,.xls" style="display:none;">
                <p>ðŸ“Š Click to upload or drag file here</p>
                <div class="help-text">Excel file containing "Cash Forecast" in the filename</div>
                <div class="error-text" id="cash_forecast_error" style="display:none;"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="income_statement">Comparative Income Statement (PDF) *</label>
            <div class="file-upload" id="income_statement_zone">
                <input type="file" id="income_statement" name="income_statement" required accept=".pdf">
                <p>ðŸ“‹ Click to upload or drag PDF file here</p>
                <div class="help-text">PDF containing "Comparative Income Statement" in the filename</div>
                <div class="error-text" id="income_statement_error" style="display:none;"></div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="balance_sheet">Balance Sheet (PDF) *</label>
            <div class="file-upload" id="balance_sheet_zone">
                <input type="file" id="balance_sheet" name="balance_sheet" required accept=".pdf">
                <p>ðŸ“ˆ Click to upload or drag PDF file here</p>
                <div class="help-text">PDF containing "Balance Sheet" in the filename</div>
                <div class="error-text" id="balance_sheet_error" style="display:none;"></div>
            </div>
        </div>
        
        <button type="submit" class="btn">Analyze Cash Forecast</button>
        <div style="text-align: center; margin-top: 10px; font-size: 0.75rem; color: #999;">
            Powered by OpenAI {{ model_name | upper }} | Data: {{ data_source | upper }}
        </div>
    </form>
</div>

<div id="loading" class="loading">
    <div class="spinner"></div>
    <h3>Analyzing Cash Forecast...</h3>
    <p>This may take a moment as we gather economic data and validate assumptions.</p>
</div>

<div id="results" style="display:none;">
    <div class="alert alert-success">
        âœ“ Analysis complete!
    </div>
    <div id="results-content"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load properties on page load
window.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/properties');
        const properties = await response.json();
        
        const select = document.getElementById('property_name');
        const loadingText = document.getElementById('loading-properties');
        
        if (response.ok && Array.isArray(properties)) {
            properties.forEach(prop => {
                const option = document.createElement('option');
                option.value = prop.entity_number;
                option.textContent = prop.property_name;
                select.appendChild(option);
            });
            loadingText.textContent = `${properties.length} properties available`;
            loadingText.style.color = '#28a745';
        } else {
            loadingText.textContent = 'Error loading properties';
            loadingText.style.color = '#dc3545';
        }
    } catch (error) {
        console.error('Error loading properties:', error);
        document.getElementById('loading-properties').textContent = 'Error loading properties';
    }
});

// Auto-populate form fields when property is selected
document.getElementById('property_name').addEventListener('change', async function() {
    const entityNumber = this.value;
    
    if (!entityNumber) {
        // Clear fields if no property selected
        document.getElementById('property_address').value = '';
        document.getElementById('zip_code').value = '';
        document.getElementById('university').value = '';
        return;
    }
    
    try {
        const response = await fetch(`/api/property/${entityNumber}`);
        const data = await response.json();
        
        if (response.ok && !data.error) {
            // Populate form fields
            document.getElementById('property_address').value = data.address || '';
            document.getElementById('zip_code').value = data.zip_code || '';
            document.getElementById('university').value = data.university || '';
        } else {
            console.error('Error fetching property details:', data.error);
        }
    } catch (error) {
        console.error('Error loading property details:', error);
    }
});

// File validation patterns (case-insensitive, handles spaces and underscores)
const fileValidation = {
    cash_forecast: {
        pattern: /cash[\s_]*forecast/i,
        message: 'Filename must contain "Cash Forecast" (with spaces or underscores)'
    },
    income_statement: {
        pattern: /comparative[\s_]*income[\s_]*statement/i,
        message: 'Filename must contain "Comparative Income Statement"'
    },
    balance_sheet: {
        pattern: /balance[\s_]*sheet/i,
        message: 'Filename must contain "Balance Sheet"'
    }
};

function validateFile(fileId, filename) {
    const validation = fileValidation[fileId];
    const errorElement = document.getElementById(fileId + '_error');
    const zone = document.getElementById(fileId + '_zone');
    
    if (!validation.pattern.test(filename)) {
        errorElement.textContent = 'âš  ' + validation.message;
        errorElement.style.display = 'block';
        zone.classList.add('has-error');
        zone.classList.remove('has-file');
        return false;
    } else {
        errorElement.style.display = 'none';
        zone.classList.remove('has-error');
        zone.classList.add('has-file');
        return true;
    }
}

// File upload handling
['cash_forecast', 'income_statement', 'balance_sheet'].forEach(fileId => {
    const input = document.getElementById(fileId);
    const zone = document.getElementById(fileId + '_zone');
    
    zone.addEventListener('click', () => input.click());
    
    input.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            const isValid = validateFile(fileId, file.name);
            
            if (isValid) {
                zone.querySelector('p').textContent = 'âœ“ ' + file.name;
            } else {
                zone.querySelector('p').textContent = 'âœ— ' + file.name;
            }
        }
    });
    
    // Drag and drop
    zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.style.borderColor = '#667eea';
    });
    
    zone.addEventListener('dragleave', () => {
        zone.style.borderColor = '';
    });
    
    zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.style.borderColor = '';
        if (e.dataTransfer.files.length > 0) {
            const file = e.dataTransfer.files[0];
            input.files = e.dataTransfer.files;
            const isValid = validateFile(fileId, file.name);
            
            if (isValid) {
                zone.querySelector('p').textContent = 'âœ“ ' + file.name;
            } else {
                zone.querySelector('p').textContent = 'âœ— ' + file.name;
            }
        }
    });
});

// Form submission
document.getElementById('analysisForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Validate all files before submission
    const cashForecastFile = document.getElementById('cash_forecast').files[0];
    const incomeStatementFile = document.getElementById('income_statement').files[0];
    const balanceSheetFile = document.getElementById('balance_sheet').files[0];
    
    let hasErrors = false;
    
    if (!cashForecastFile || !validateFile('cash_forecast', cashForecastFile.name)) {
        hasErrors = true;
    }
    
    if (!incomeStatementFile || !validateFile('income_statement', incomeStatementFile.name)) {
        hasErrors = true;
    }
    
    if (!balanceSheetFile || !validateFile('balance_sheet', balanceSheetFile.name)) {
        hasErrors = true;
    }
    
    if (hasErrors) {
        showError('Please ensure all files have the correct names before submitting.');
        return;
    }
    
    const formData = new FormData(e.target);
    
    // Show loading, hide form
    document.getElementById('upload-form').style.display = 'none';
    document.getElementById('loading').classList.add('active');
    
    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            // The endpoint returns HTML, so display it
            const html = await response.text();
            document.open();
            document.write(html);
            document.close();
        } else {
            // Try to parse error as JSON
            try {
                const result = await response.json();
                showError(result.error || 'An error occurred during analysis');
            } catch {
                showError('An error occurred during analysis');
            }
        }
    } catch (error) {
        showError('Network error: ' + error.message);
    }
});

function displayResults(result) {
    document.getElementById('loading').classList.remove('active');
    document.getElementById('results').style.display = 'block';
    
    const summary = result.summary;
    const bullets = summary.bullets || [];
    
    let html = `
        <h2>Executive Summary: ${summary.property_name}</h2>
        <p><strong>Analysis Date:</strong> ${new Date(summary.analysis_date).toLocaleString()}</p>
        <p><strong>Recommendation Validation:</strong> ${summary.recommendation_validation}</p>
        
        <div style="margin: 30px 0; padding: 20px; background: #f8f9fa; border-radius: 5px;">
            <h3>Key Findings:</h3>
            <ul style="list-style: none; padding: 0;">
    `;
    
    bullets.forEach(bullet => {
        html += `
            <li style="margin: 15px 0; padding: 15px; background: white; border-radius: 5px; border-left: 4px solid #667eea;">
                <strong>${bullet.id}.</strong> ${bullet.text}
                ${bullet.has_details ? '<a href="#" style="color: #667eea; margin-left: 10px;">[Details]</a>' : ''}
            </li>
        `;
    });
    
    html += `
            </ul>
        </div>
        
        <p style="margin-top: 30px;">
            <a href="/" class="btn" style="display: inline-block; text-decoration: none;">Analyze Another Property</a>
        </p>
    `;
    
    document.getElementById('results-content').innerHTML = html;
}

function showError(message) {
    document.getElementById('loading').classList.remove('active');
    document.getElementById('upload-form').style.display = 'block';
    
    const alert = document.createElement('div');
    alert.className = 'alert alert-error';
    alert.textContent = 'âœ— ' + message;
    
    document.getElementById('upload-form').insertBefore(
        alert,
        document.getElementById('upload-form').firstChild
    );
}
</script>
{% endblock %}
